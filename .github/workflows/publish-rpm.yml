name: Publish RPM Packages

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Release tag to publish (for example: v2.0.0)"
        required: true
        type: string

permissions:
  contents: read

jobs:
  publish-rpm:
    runs-on: ubuntu-latest
    steps:
      - name: Validate Cloudsmith configuration
        run: |
          set -euo pipefail
          if [ -z "${{ secrets.CLOUDSMITH_API_KEY }}" ]; then
            echo "Secret CLOUDSMITH_API_KEY is required."
            exit 1
          fi
          if [ -z "${{ vars.CLOUDSMITH_REPO }}" ]; then
            echo "Repository variable CLOUDSMITH_REPO is required (example: vincentkoc/autosecure)."
            exit 1
          fi

      - name: Download release .rpm assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ inputs.tag_name }}
        run: |
          set -euo pipefail
          mkdir -p dist
          gh release download "${TAG}" \
            --repo "${GITHUB_REPOSITORY}" \
            --pattern "*.rpm" \
            --dir dist
          ls -1 dist/*.rpm >/dev/null

      - name: Install Cloudsmith CLI
        run: |
          set -euo pipefail
          python3 -m pip install --upgrade pip
          python3 -m pip install cloudsmith-cli

      - name: Publish to Cloudsmith RPM repository
        env:
          CLOUDSMITH_API_KEY: ${{ secrets.CLOUDSMITH_API_KEY }}
          CLOUDSMITH_REPO: ${{ vars.CLOUDSMITH_REPO }}
          CLOUDSMITH_RPM_DISTRIBUTION: ${{ vars.CLOUDSMITH_RPM_DISTRIBUTION }}
          CLOUDSMITH_RPM_RELEASE: ${{ vars.CLOUDSMITH_RPM_RELEASE }}
        run: |
          set -euo pipefail

          DISTRO="${CLOUDSMITH_RPM_DISTRIBUTION:-el}"
          RELEASE="${CLOUDSMITH_RPM_RELEASE:-9}"
          TARGET="${CLOUDSMITH_REPO}/${DISTRO}/${RELEASE}"

          for pkg in dist/*.rpm; do
            cloudsmith push rpm "${TARGET}" "${pkg}" --no-wait-for-sync
          done
